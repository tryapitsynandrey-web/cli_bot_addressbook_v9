<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Book Dashboard</title>
    <!-- Simple, sleek fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;      /* Deep slate */
            --surface-1: #1e293b;     /* Slate */
            --surface-2: #334155;     /* Lighter slate */
            --text-main: #f8fafc;     /* White/Gray */
            --text-muted: #94a3b8;    /* Muted Gray */
            --accent: #38bdf8;        /* Light blue */
            --accent-glow: #0ea5e9;   /* Deeper blue */
            --error: #f43f5e;
            --border: #475569;
            --tag-bg: #0f766e;
            --tag-text: #ccfbf1;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s ease-in-out;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
        }

        /* --- Header & Search --- */
        header {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--surface-1);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 500px;
        }

        .search-wrapper input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background-color: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: var(--radius-md);
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .search-wrapper input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        .search-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            width: 1.25rem;
            height: 1.25rem;
        }

        .stats {
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* --- Table Layout --- */
        .table-container {
            width: 100%;
            background-color: var(--surface-1);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden; /* For border radius */
            overflow-x: auto; /* For mobile tables */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background-color: rgba(0,0,0,0.2);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            backdrop-filter: blur(8px);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--surface-2);
            vertical-align: top;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr {
            transition: var(--transition);
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* --- Cell Formatting --- */
        .contact-name {
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--surface-2), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }

        .contact-phones, .contact-notes {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .contact-email a {
            color: var(--accent);
            text-decoration: none;
            transition: var(--transition);
        }

        .contact-email a:hover {
            color: var(--text-main);
            text-decoration: underline;
        }

        .contact-birthday {
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
        }

        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .badge {
            background-color: var(--tag-bg);
            color: var(--tag-text);
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        
        .empty-cell {
            color: var(--surface-2);
            font-style: italic;
        }

        /* --- Loading / Error States --- */
        .status-msg {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .status-msg.error {
            color: var(--error);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .controls { flex-direction: column; align-items: stretch; }
            th, td { padding: 0.75rem 1rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Address Book</h1>
            
            <div class="controls">
                <div class="search-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by name, email, phone, tag, or note...">
                </div>
                <div class="stats" id="statsDisplay">
                    Loading contacts...
                </div>
            </div>
        </header>

        <main>
            <div class="table-container">
                <table id="contactsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phones</th>
                            <th>Email</th>
                            <th>Birthday</th>
                            <th>Tags</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
                <div id="statusMessage" class="status-msg">
                    <div class="spinner"></div>
                    <div>Fetching address book data...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const table = document.getElementById('contactsTable');
        const tbody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const statsDisplay = document.getElementById('statsDisplay');
        const statusMessage = document.getElementById('statusMessage');

        // State
        let allContacts = []; // Array of objects
        
        // Data Sources (Fallback mechanism)
        const DATA_SOURCES = [
            'test_addressbook/ex_contacts.json',
            'user_address_book/contacts.json',
            'contacts.json'
        ];

        // Init
        async function loadData() {
            for (const url of DATA_SOURCES) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    if (data && typeof data === 'object') {
                        // Transform dict to array suitable for sorting/filtering
                        allContacts = Object.entries(data).map(([name, info]) => {
                            return {
                                name: name,
                                phones: info.phones || [],
                                email: info.email || '',
                                birthday: info.birthday || '',
                                notes: info.notes || [],
                                tags: info.tags || []
                            };
                        });
                        
                        initUI();
                        return; // Stop looking after first success
                    }
                } catch (e) {
                    console.warn(`Failed to fetch ${url}`, e);
                }
            }
            
            // If we exhaust all sources without success
            showError("Could not locate contacts data. Ensure the Python CLI has generated 'contacts.json' and the HTTP server is running at the project root.");
        }

        function showError(msg) {
            statusMessage.innerHTML = `<div style="margin-bottom: 0.5rem;">⚠️</div><div>${msg}</div>`;
            statusMessage.classList.add('error');
            statusMessage.style.display = 'block';
            table.style.display = 'none';
            statsDisplay.textContent = '0 contacts found';
        }

        function initUI() {
            statusMessage.style.display = 'none';
            table.style.display = 'table';
            
            // Sort alphabetically by name
            allContacts.sort((a, b) => a.name.localeCompare(b.name));
            
            renderTable(allContacts);
            
            // Setup Search Listener
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                filterTable(query);
            });
        }
        
        // Helper to extract initials for avatar
        function getInitials(name) {
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2);
            return (parts[0][0] + parts[parts.length - 1][0]);
        }

        function renderTable(contacts) {
            tbody.innerHTML = ''; // Clear
            
            if (contacts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-muted); font-style: italic;">No contacts match your search.</td></tr>`;
                statsDisplay.textContent = `0 of ${allContacts.length} contacts`;
                return;
            }

            statsDisplay.textContent = `${contacts.length} ${contacts.length === 1 ? 'contact' : 'contacts'}`;

            const fragment = document.createDocumentFragment();

            contacts.forEach(c => {
                const tr = document.createElement('tr');
                
                // Name & Avatar
                const tdName = document.createElement('td');
                tdName.innerHTML = `
                    <div class="contact-name">
                        <div class="avatar">${getInitials(c.name)}</div>
                        <span>${c.name}</span>
                    </div>
                `;
                
                // Phones
                const tdPhones = document.createElement('td');
                tdPhones.className = 'contact-phones';
                tdPhones.innerHTML = c.phones.length > 0 
                    ? c.phones.join('<br>') 
                    : '<span class="empty-cell">—</span>';
                    
                // Email
                const tdEmail = document.createElement('td');
                tdEmail.className = 'contact-email';
                if (c.email) {
                    tdEmail.innerHTML = `<a href="mailto:${c.email}">${c.email}</a>`;
                } else {
                    tdEmail.innerHTML = '<span class="empty-cell">—</span>';
                }
                
                // Birthday
                const tdBirthday = document.createElement('td');
                tdBirthday.className = 'contact-birthday';
                tdBirthday.innerHTML = c.birthday || '<span class="empty-cell">—</span>';
                
                // Tags
                const tdTags = document.createElement('td');
                const tagList = document.createElement('div');
                tagList.className = 'badge-list';
                if (c.tags.length > 0) {
                    c.tags.forEach(tag => {
                        const span = document.createElement('span');
                        span.className = 'badge';
                        span.textContent = tag;
                        tagList.appendChild(span);
                    });
                } else {
                    tagList.innerHTML = '<span class="empty-cell">—</span>';
                }
                tdTags.appendChild(tagList);
                
                // Notes
                const tdNotes = document.createElement('td');
                tdNotes.className = 'contact-notes';
                if (c.notes.length > 0) {
                    // Combine notes if multiple exist, separated by faint divider
                    tdNotes.innerHTML = c.notes.map(n => `<div>${n}</div>`).join('<div style="margin:4px 0; border-bottom: 1px dashed var(--surface-2);"></div>');
                } else {
                    tdNotes.innerHTML = '<span class="empty-cell">—</span>';
                }

                // Append cells
                tr.appendChild(tdName);
                tr.appendChild(tdPhones);
                tr.appendChild(tdEmail);
                tr.appendChild(tdBirthday);
                tr.appendChild(tdTags);
                tr.appendChild(tdNotes);
                
                fragment.appendChild(tr);
            });
            
            tbody.appendChild(fragment);
        }

        // Filtering logic: checks name, emails, phones, notes, tags
        function filterTable(query) {
            if (!query) {
                renderTable(allContacts);
                return;
            }
            
            const filtered = allContacts.filter(c => {
                // Check name
                if (c.name.toLowerCase().includes(query)) return true;
                // Check email
                if (c.email && c.email.toLowerCase().includes(query)) return true;
                // Check birthday
                if (c.birthday && c.birthday.includes(query)) return true;
                // Check phones array
                if (c.phones.some(p => p.includes(query))) return true;
                // Check tags array
                if (c.tags.some(t => t.toLowerCase().includes(query))) return true;
                // Check notes array
                if (c.notes.some(n => n.toLowerCase().includes(query))) return true;
                
                return false;
            });
            
            renderTable(filtered);
        }

        // Boot
        document.addEventListener('DOMContentLoaded', loadData);

    </script>
</body>
</html>
